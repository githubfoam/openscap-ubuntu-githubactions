name: "ubuntu 1804 OpenSCAP CI workflow"


on:
  push:
    branches: [ test ]
  schedule:
      - cron:  '0 0 1 * *' ##execution of a task in the first minute of the month  


jobs:

  ubuntu-1804-job:
    name: "OpenSCAP on ubuntu-18.04"
    runs-on: ubuntu-18.04
    env:
      distribution: "ubuntu"
      version: "bionic"   
    steps:
    - uses: actions/checkout@v2
    - name: "os fingerprinting"
      run: hostnamectl status  
    # - name: "Run OpenSCAP audit"
    #   run: |
    #     sudo apt-get update -yq
    #     sudo apt-get install libopenscap8 wget  -yq
    #     # download the necessary OVAL definitions
    #     if wget --spider https://people.canonical.com/~ubuntu-security/oval/com.ubuntu.${version}.cve.oval.xml 2>/dev/null; then
    #       echo "OVAL file exists"
    #     else
    #       echo "OVAL file does not exist"
    #     fi        
    #     wget https://people.canonical.com/~ubuntu-security/oval/com.ubuntu.${version}.cve.oval.xml
    #     # Run the audit 
    #     # https://wiki.ubuntu.com/Releases
    #     oscap oval eval --results /tmp/${version}_oscap_results.xml --report /tmp/${version}_oscap_report.html com.ubuntu.${version}.cve.oval.xml
    #     sudo cp /tmp/${version}_oscap_report.html /var/www/html/
    #     # browse http://SERVER_IP/${version}_oscap_report.html
    - name: "Run OpenSCAP audit"
      run: |
        sudo apt-get update -yq
        # https://www.open-scap.org/getting-started/
        # https://www.open-scap.org/tools/openscap-base/#download
        # oscap tool from OpenSCAP Base        
        sudo apt-get install libopenscap8  -yq
        # https://www.open-scap.org/security-policies/scap-security-guide/#install
        sudo apt-get install ssg-base ssg-debderived ssg-debian ssg-nondebian ssg-applications -yq
        ls -lai /usr/share/scap-security-guide/ssg-ubuntu*-ds.xml
        # OpenSCAP Error: Unable to open file: '/usr/share/xml/scap/ssg/content/ssg-ubuntu1604-ds.xml' [../../../src/source/oscap_source.c:284]
        # Could not determine document type
        # sudo oscap info /usr/share/xml/scap/ssg/content/ssg-ubuntu1604-ds.xml
        # pulling the latest OpenSCAP security guide from github to get the latest scans
        git clone https://github.com/ComplianceAsCode/content.git cd Comp*
        ./build_product ubuntu18.04

